<!-- frontend/index.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>주식 시뮬레이터 · 서버연동(관리자 3연타/비속어 차단/문의 Admin/가격강제 금액)</title>
<style>
:root{--bg:#0b0c10;--card:#151821;--muted:#99a3b3;--text:#e9edf3;--brand:#5b8cff;--accent:#2ee59d;--danger:#ff4d61;--grid:#232634;--border:#222636}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0a0b0f,#0c1020 40%,#0a0b0f 100%);color:var(--text);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
.container{max-width:1200px;margin:24px auto;padding:0 16px}
h1{margin:0 0 10px;font-size:22px}
.header{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.badge{font-size:12px;padding:4px 8px;border:1px solid #2b3042;border-radius:999px;color:#b7c2d9;background:#0e1220}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:end}
.card{background:linear-gradient(180deg,#111526,#0f1424);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.28);margin-bottom:14px}
.card h2{margin:0 0 8px;font-size:16px;color:#dbe4ff}
.input,.select,textarea{background:#0f1322;color:var(--text);border:1px solid #2b3042;border-radius:10px;padding:10px 12px;outline:none;min-width:120px}
.input:focus,.select:focus,textarea:focus{border-color:#3b64ff}
.btn{border:1px solid #2b3042;background:#121830;color:#e9edf3;padding:10px 14px;border-radius:10px;cursor:pointer}
.btn:hover{border-color:#3b64ff}
.btn.brand{background:linear-gradient(180deg,#4f73ff,#3156ff);border-color:#3156ff;color:#fff}
.btn.accent{background:linear-gradient(180deg,#2ee59d,#15c57e);border:none;color:#0a0b0f}
.btn.danger{background:linear-gradient(180deg,#ff5f74,#ff2d49);border:none;color:#fff}
.small{font-size:12px;color:var(--muted)}
.grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
@media (max-width:1000px){.grid{grid-template-columns:1fr}}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #20263a;padding:8px 6px;text-align:right}
.table th:first-child,.table td:first-child{text-align:left}
.table tr:hover{background:#0e1220}
.kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kpi .box{background:#0f1322;border:1px solid #2b3042;border-radius:12px;padding:12px}
.kpi .label{font-size:11px;color:#9aa6bf}
.kpi .value{font-size:18px;margin-top:4px}
.flex{display:flex;gap:8px;flex-wrap:wrap}
.sep{border:none;border-top:1px dashed #26304a;margin:10px 0}
.canvas-wrap{position:relative;height:220px}
canvas{width:100%;height:220px;background:repeating-linear-gradient(0deg,var(--grid) 0 1px,transparent 1px 26px)}
.help{font-size:13px;color:#9aa6bf;margin-left:6px}
#cmdlog{background:#0f1322;border:1px solid #2b3042;border-radius:10px;padding:10px;height:120px;overflow:auto;white-space:pre-wrap}
kbd{background:#0f1322;border:1px solid #2b3042;border-radius:6px;padding:2px 6px;color:#b7c2d9}
.status{display:flex;gap:6px;align-items:center}
.pill{border:1px solid #2b3042;border-radius:999px;padding:3px 8px;font-size:11px;color:#9fb3d9;cursor:pointer}
.pill.green{border-color:#1f6f4a;color:#a6f3cd}
.pill.red{border-color:#7f2230;color:#ffb3be}
.hidden{display:none}
.toast{position:fixed;right:16px;bottom:16px;background:#10162a;border:1px solid #2b3042;color:#e9edf3;padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.4);opacity:0;transform:translateY(12px);transition:all .25s}
.toast.show{opacity:1;transform:translateY(0)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px}
.modal .dialog{background:#12162a;border:1px solid #2b3042;border-radius:14px;max-width:520px;width:100%;padding:16px}
.dialog h3{margin:0 0 8px}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.warn{color:#ffb3be}
.success{color:#a6f3cd}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>주식 시뮬레이터(데모)</h1>
    <span class="badge">서버 로그인/세션</span>
    <span class="badge">관리자 3연타(3초)</span>
    <span class="badge">비속어 차단</span>
    <span class="badge">문의 Admin 전체 조회</span>
    <span class="badge">가격강제 금액입력</span>
  </div>

  <!-- 로그인/가입 -->
  <div id="authView" class="grid">
    <div class="card">
      <h2>로그인</h2>
      <div class="row">
        <label>계정ID<br><input id="loginId" class="input" placeholder="account_id"></label>
        <label>비밀번호<br><input id="loginPw" type="password" class="input" placeholder="4~64자"></label>
        <button id="btnLogin" class="btn brand">로그인</button>
        <button id="btnOpenHelp" class="btn">문의하기</button>
      </div>
      <p id="loginStatus" class="small"></p>
      <div id="lockBanner" class="card small hidden" style="background:#101429">
        <div><strong>보안 경고</strong> — 비정상적인 로그인 시도가 감지되었습니다. 복구 PIN으로 해제하거나 잠시 후 다시 시도하세요.</div>
        <div class="row" style="margin-top:8px">
          <button id="btnOpenRecovery" class="btn accent">복구 PIN으로 해제</button>
          <button class="btn" id="btnOpenHelp2">문의하기</button>
          <span class="help" id="lockTimer"></span>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>회원가입</h2>
      <div class="row">
        <label>계정ID(영문/숫자/_ 4~16)<br><input id="regId" class="input"></label>
        <label>닉네임(2~16)<br><input id="regNick" class="input"></label>
        <label>비밀번호(4~64)<br><input id="regPw" type="password" class="input"></label>
        <label>복구 PIN(선택, 6~8 숫자)<br><input id="regPin" class="input" placeholder="예: 123456"></label>
        <button id="btnRegister" class="btn brand">가입</button>
      </div>
      <p class="small">비속어 포함 시 가입/로그인이 제한됩니다.</p>
    </div>
  </div>

  <!-- 앱 -->
  <div id="appView" class="hidden">
    <div class="card status">
      <span id="who" class="pill"></span>
      <span id="rolePill" class="pill"></span>
      <button id="btnLogout" class="btn">로그아웃</button>
      <button id="btnHelpIn" class="btn">문의하기</button>
      <div style="flex:1"></div>
      <span class="small">힌트: <span class="mono">역할 배지를 3초 내 3번 누르면 관리자 인증창</span></span>
    </div>

    <div class="grid">
      <div>
        <div class="card">
          <h2>주문</h2>
          <div class="row">
            <label>심볼<br><input id="sym" class="input" value="AAPL"></label>
            <label>수량<br><input id="qty" type="number" min="1" class="input" value="10"></label>
            <label>매수/매도<br>
              <select id="side" class="select"><option value="buy">매수</option><option value="sell">매도</option></select>
            </label>
            <label>유형<br>
              <select id="otype" class="select"><option value="market">시장가</option><option value="limit">지정가</option></select>
            </label>
            <label>지정가<br><input id="lpx" type="number" class="input" placeholder="-"></label>
            <button id="place" class="btn brand">주문하기</button>
          </div>
          <div class="row" style="margin-top:8px">
            <label>수수료(bps)<br><input id="fee" type="number" class="input" value="10"></label>
            <label>슬리피지(bps)<br><input id="slip" type="number" class="input" value="5"></label>
            <label>시나리오<br>
              <select id="scenario" class="select">
                <option value="training">훈련(70%)</option>
                <option value="normal">일반(50%)</option>
                <option value="learning">학습(30%)</option>
              </select>
            </label>
            <button id="next" class="btn accent">다음 날 ▶</button>
            <button id="reset" class="btn danger">초기화</button>
          </div>
          <p class="small">시장가: 다음날 시가 체결 · 지정가: 다음날 시가 조건 만족 시 체결 · 수수료/슬리피지 반영.</p>
          <hr class="sep">
          <div class="kpi">
            <div class="box"><div class="label">현금</div><div id="kpi-cash" class="value">$0</div></div>
            <div class="box"><div class="label">총자산</div><div id="kpi-eq" class="value">$0</div></div>
            <div class="box"><div class="label">CAGR</div><div id="kpi-cagr" class="value">—</div></div>
            <div class="box"><div class="label">최대낙폭</div><div id="kpi-dd" class="value">—</div></div>
          </div>
        </div>

        <div class="card">
          <h2>에쿼티 커브</h2>
          <div class="canvas-wrap"><canvas id="chart" width="1000" height="220"></canvas></div>
          <div id="tags" class="flex" style="margin-top:8px"></div>
        </div>

        <div class="card">
          <h2>명령어</h2>
          <div class="row">
            <input id="cmd" class="input" style="flex:1" placeholder="예) buy AAPL 5 market / sell TSLA all / next 3 / set fee 8 / help">
            <button id="run" class="btn brand">실행</button>
          </div>
          <div id="cmdlog" style="margin-top:8px"></div>
          <p class="small">단축: <kbd>B1</kbd> 매수, <kbd>S1</kbd> 매도, <kbd>N5</kbd> 5일 진행, <kbd>H1</kbd> 도움말.</p>
        </div>

        <div class="card">
          <h2>보유 포지션</h2>
          <table class="table" id="pos"><thead><tr><th>종목</th><th>수량</th><th>평단</th><th>현재가</th><th>평가손익</th></tr></thead><tbody></tbody></table>
        </div>

        <div class="card">
          <h2>체결 내역</h2>
          <table class="table" id="fills"><thead><tr><th>일자</th><th>종목</th><th>사이드</th><th>수량</th><th>체결가</th><th>수수료</th></tr></thead><tbody></tbody></table>
        </div>

        <div class="card">
          <h2>가격(일봉)</h2>
          <table class="table" id="px"><thead><tr><th>종목</th><th>시가</th><th>고가</th><th>저가</th><th>종가</th></tr></thead><tbody></tbody></table>
          <p class="small">심볼별 시드 랜덤 워크 + 점프/이벤트. 새 종목 주문 시 자동 생성.</p>
        </div>
      </div>

      <div>
        <div class="card">
          <h2>관리자 & OTK</h2>
          <div class="row">
            <input id="adminTrigger" class="input mono" placeholder="역할 배지 3초내 3번 클릭 → 비번 입력">
            <button id="btnAdminTrigger" class="btn">힌트</button>
          </div>
          <div class="row" style="margin-top:8px">
            <input id="otk" class="input mono" placeholder="원타임 키 (ADMIN2025243295+X)">
            <button id="btnOTK" class="btn">임시 관리자</button>
          </div>
          <p class="small">관리자 문의 열람 가능. OTK: 유효 20분 / 서버 검증.</p>
          <hr class="sep">
          <div id="adminPanel" class="hidden">
            <div class="status" style="margin-bottom:8px">
              <span class="pill green">PERMANENT ADMIN</span>
              <span id="todayAdminCount" class="pill">오늘 고유 관리자 수: —</span>
            </div>
            <div class="row">
              <button id="btnRiskReset" class="btn danger">[위험] 전체 초기화</button>
              <button id="btnRiskDeleteAccount" class="btn danger">[위험] 계정 삭제</button>
              <button id="btnRiskForcePrice" class="btn">[위험] 주가 강제(금액/%)</button>
            </div>
            <p class="small">위험 명령은 <b>계정ID 입력 + 10초 유예</b> 후 실행, 서버 로그 기록.</p>
          </div>
          <div id="tempPanel" class="hidden">
            <span class="pill">TEMP ADMIN(20분)</span>
          </div>
        </div>

        <div class="card">
          <h2>문의하기</h2>
          <div class="row">
            <select id="helpCat" class="select">
              <option>로그인/복구</option><option>계정/비밀번호</option><option>포인트/업적</option><option>시나리오/이벤트</option><option>버그/오류</option><option>제안/피드백</option>
            </select>
            <input id="helpTitle" class="input" placeholder="제목">
          </div>
          <div class="row" style="margin-top:8px">
            <textarea id="helpBody" class="input" style="min-height:90px;flex:1" placeholder="상황을 자세히 적어주세요."></textarea>
          </div>
          <div class="row" style="margin-top:8px">
            <label><input type="checkbox" id="helpMeta" checked> 자동 메타(세션/브라우저/최근로그) 첨부 동의</label>
            <button id="btnSubmitTicket" class="btn brand">문의 제출</button>
          </div>
          <div id="ticketsBox" class="small" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 위험 명령 모달 -->
<div id="riskModal" class="modal">
  <div class="dialog">
    <h3>위험 명령 확인</h3>
    <p id="riskSummary" class="small">이 작업은 시스템에 큰 영향을 줄 수 있습니다. 계속하려면 현재 로그인한 계정ID를 정확히 입력하세요. 실행 전 10초 유예가 있습니다.</p>
    <div class="row">
      <label>계정ID 재입력<br><input id="riskAccount" class="input" placeholder="현재 로그인한 계정ID"></label>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="riskConfirm" class="btn danger">실행(10초 유예)</button>
      <button id="riskCancel" class="btn">취소</button>
      <span id="riskCountdown" class="help"></span>
    </div>
  </div>
</div>

<!-- 복구 PIN 모달 -->
<div id="recoveryModal" class="modal">
  <div class="dialog">
    <h3>복구 PIN</h3>
    <p class="small">하드 락 해제를 위해 등록된 복구 PIN(6~8자리)을 입력하세요.</p>
    <div class="row">
      <input id="pinInput" class="input" placeholder="6~8자리 숫자">
      <button id="pinVerify" class="btn brand">해제</button>
      <button id="pinClose" class="btn">닫기</button>
    </div>
    <p id="pinMsg" class="small"></p>
  </div>
</div>

<!-- 관리자 비밀번호 모달 -->
<div id="adminPwModal" class="modal">
  <div class="dialog">
    <h3>관리자 인증</h3>
    <p class="small">관리자 비밀번호를 입력하면 관리자 권한으로 전환됩니다.</p>
    <div class="row">
      <input id="adminPwInput" type="password" class="input" placeholder="관리자 비밀번호">
      <button id="adminPwSubmit" class="btn brand">확인</button>
      <button id="adminPwClose" class="btn">취소</button>
    </div>
    <p id="adminPwMsg" class="small"></p>
  </div>
</div>

<!-- 문의 모달(로그인 화면) -->
<div id="helpModal" class="modal">
  <div class="dialog">
    <h3>문의하기</h3>
    <div class="row">
      <select id="mCat" class="select"><option>로그인/복구</option><option>계정/비밀번호</option><option>기타</option></select>
      <input id="mTitle" class="input" placeholder="제목">
    </div>
    <div class="row" style="margin-top:8px">
      <textarea id="mBody" class="input" style="min-height:90px;flex:1" placeholder="상황을 자세히 적어주세요."></textarea>
    </div>
    <div class="row" style="margin-top:8px">
      <label><input type="checkbox" id="mMeta" checked> 자동 메타 첨부 동의</label>
      <button id="mSubmit" class="btn brand">제출</button>
      <button id="mClose" class="btn">닫기</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===== 서버 API ===== */
const API_BASE='http://localhost:4000';
async function api(path, opts={}){
  const res = await fetch(API_BASE+path,{
    method: opts.method||'GET',
    headers: { 'Content-Type':'application/json', ...(opts.headers||{}) },
    credentials: 'include',
    body: opts.body? JSON.stringify(opts.body): undefined
  });
  const data = await res.json().catch(()=>({}));
  if(!res.ok) throw Object.assign(new Error(data.msg||'API error'), {status:res.status, data});
  return data;
}

/* ===== 유틸 ===== */
const $=s=>document.querySelector(s);
const fmt=n=>(n>=0?'':'-')+'$'+Math.abs(n).toLocaleString(undefined,{maximumFractionDigits:2});
const fnum=n=>Number(n).toLocaleString(undefined,{maximumFractionDigits:2});
const nowTs=()=>Date.now();
function toast(msg){ const el=$('#toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2500); }

/* ===== 로컬 스토리지 ===== */
const DB={ get(k,def){try{const v=localStorage.getItem(k); return v?JSON.parse(v):def}catch(e){return def}}, set(k,v){localStorage.setItem(k,JSON.stringify(v))}, del(k){localStorage.removeItem(k)} };

/* ===== 세션 ===== */
const AUTH={
  session(){ return DB.get('auth.session',null) },
  setSession(s){ DB.set('auth.session',s) },
  clearSession(){ DB.del('auth.session') },
  async me(){ try{ const r=await api('/me'); return r.user; }catch{ return null; } }
};

/* ===== 관리자 3초내 3연타 ===== */
let roleClickCount = 0;
let roleClickTimer = null;
function openAdminPwModal(){ $('#adminPwInput').value=''; $('#adminPwMsg').textContent=''; $('#adminPwModal').style.display='flex'; }
function closeAdminPwModal(){ $('#adminPwModal').style.display='none'; }

/* ===== 위험 게이트 ===== */
const RISK={ timer:null,remain:0,resolve:null,
  async open({summary}){ $('#riskSummary').textContent=summary; $('#riskAccount').value=''; $('#riskCountdown').textContent=''; $('#riskModal').style.display='flex'; return new Promise(res=>{ this.resolve=res; }); },
  close(){ $('#riskModal').style.display='none'; if(this.timer){clearInterval(this.timer); this.timer=null;} if(this.resolve){ const r=this.resolve; this.resolve=null; r(false);} },
  startCountdown(){ this.remain=10; $('#riskCountdown').textContent='유예: 10초';
    this.timer=setInterval(()=>{ this.remain--; $('#riskCountdown').textContent='유예: '+this.remain+'초'; if(this.remain<=0){ clearInterval(this.timer); this.timer=null; const r=this.resolve; this.resolve=null; if(r) r(true); $('#riskModal').style.display='none'; } },1000); }
};

async function getCurrentUser(){ return await AUTH.me(); }

/* ===== 시뮬레이터 ===== */
const SIM={
  key:'sim.state.v1',
  initState(){ return {cash:1000,positions:{},orders:[],fills:[],prices:{},equity:[],day:0,seed:12345,settings:{feeBps:10,slippageBps:5},scenario:'training'}},
  S:null,
  hash(s){let h=0; for(let i=0;i<s.length;i++) h=((h<<5)-h+s.charCodeAt(i))|0; return h;},
  rng(seed=123456789){let x=seed|0; if(x===0)x=1; return ()=>{x^=x<<13;x^=x>>>17;x^=x<<5; return (x>>>0)/2**32;}},
  startDate:new Date('2022-01-03T00:00:00Z').getTime(),
  makeSeries(symbol,seed=42,startPx=100){ const r=this.rng(seed); let last=startPx; const bars=[];
    for(let i=0;i<30;i++){ const vol=0.03+r()*0.06, drift=-0.001+r()*0.002; const shock=(r()<0.06)?((r()*0.20+0.05)*(r()<0.5?-1:1)):0;
      const ret=drift+(r()*2-1)*vol+shock; const open=last*(1+(r()*2-1)*0.003); const close=Math.max(1,open*(1+ret));
      const high=Math.max(open,close)*(1+r()*0.004); const low=Math.min(open,close)*(1-r()*0.004);
      const t=this.startDate+i*86400000; bars.push({t,o:open,h:high,l:low,c:close}); last=close; } return bars; },
  nextBar(prev){ const last=prev.at(-1); const t=last.t+86400000; const r=this.rng((t^0x9e3779b9)>>>0);
    const vol=0.03+r()*0.06, drift=-0.001+r()*0.002; const shock=(r()<0.06)?((r()*0.20+0.05)*(r()<0.5?-1:1)):0;
    const ret=drift+(r()*2-1)*vol+shock; const open=last.c*(1+(r()*2-1)*0.003); const close=Math.max(1,open*(1+ret)); const high=Math.max(open,close)*(1+r()*0.004); const low=Math.min(open,close)*(1-r()*0.004); return {t,o:open,h:high,l:low,c:close}; },
  ensure(sym){ if(!this.S.prices[sym]){ const start=60+((Math.random()*140)|0); this.S.prices[sym]=this.makeSeries(sym,(this.S.seed ^ this.hash(sym))>>>0,start);} },
  eventProb(p){ return p==='training'?0.70: p==='learning'?0.30:0.50; },
  applyEvents(sym){ const p=this.eventProb(this.S.scenario||'training'); if(Math.random()<p){ const arr=this.S.prices[sym]; const last=arr.at(-1);
      const bump=(Math.random()<0.5?-1:1)*(0.05+Math.random()*0.15); last.c=Math.max(0.5,last.c*(1+bump)); last.h=Math.max(last.h,last.c)*(1+Math.random()*0.01); last.l=Math.min(last.l,last.c)*(1-Math.random()*0.01); log(`[이벤트] ${sym} 변동 (${(p*100)|0}%)`); } },
  async save(){
    try{ const me=await getCurrentUser(); if(me){ await api('/sim/state',{method:'PUT',body:{state:this.S}}); } else { DB.set(this.key,this.S); } }
    catch{ DB.set(this.key,this.S); }
  },
  async load(){
    try{ const me=await getCurrentUser(); if(me){ const r=await api('/sim/state'); if(r.state){ this.S=r.state; } else { this.S=this.initState(); await this.save(); } return; } }
    catch{}
    const x=DB.get(this.key,null); this.S=x||this.initState(); if(!x) await this.save();
  },
  markEquity(){ let mkt=0; for(const [sym,p] of Object.entries(this.S.positions)){ if(!p.qty) continue; this.ensure(sym); const last=this.S.prices[sym].at(-1).c; mkt+=p.qty*last; }
    const any=Object.keys(this.S.prices)[0]; this.S.equity.push({t:any?this.S.prices[any].at(-1).t:(this.startDate+this.S.day*86400000), v:this.S.cash+mkt}); },
  metrics(){ if((this.S.equity||[]).length<3) return {cagr:NaN,maxdd:NaN}; const eq=this.S.equity.map(d=>d.v); const years=(eq.length-1)/252;
    const cagr=Math.pow(eq.at(-1)/eq[0],1/Math.max(1e-9,years))-1; let peak=-Infinity,maxdd=0; for(const v of eq){ peak=Math.max(peak,v); maxdd=Math.min(maxdd, v/peak-1); } return {cagr,maxdd}; },
  place({symbol,qty,side,type,limit}){ symbol=(symbol||'').toUpperCase()||'AAPL'; qty=Math.max(1,qty|0); this.ensure(symbol);
    if(side==='sell'){ const have=(this.S.positions[symbol]?.qty)||0; if(qty>have){ log(`보유 수량 부족: ${symbol} 보유=${have}, 요청=${qty}. 주문 거절.`); return; } }
    const now=this.S.prices[symbol].at(-1); this.S.orders.push({id:'o'+Date.now(),date:new Date(now.t).toISOString().slice(0,10),symbol,qty,side,type,limit:limit??null}); },
  fill(o,open){ const fee=(+this.S.settings.feeBps||0)/10000; const slip=(+this.S.settings.slippageBps||0)/10000;
    const px=open*(o.side==='buy'?(1+slip):(1-slip)); const notion=px*o.qty; const fees=Math.max(1, notion*fee); const mult=(o.side==='buy'?+1:-1);
    const P=this.S.positions[o.symbol]||{qty:0,avg:0}; const newQty=P.qty+mult*o.qty; if(newQty<0){ log(`체결 중단: 보유보다 많이 팔 수 없음`); return; }
    const newAvg=newQty===0?0:(P.avg*P.qty+(mult>0?px*o.qty:0))/newQty; this.S.positions[o.symbol]={qty:newQty,avg:newAvg}; this.S.cash -= mult*notion + fees;
    const bar=this.S.prices[o.symbol].at(-1); this.S.fills.unshift({date:new Date(bar.t).toISOString().slice(0,10),symbol:o.symbol,side:o.side,qty:o.qty,px,fees:+fees.toFixed(2)}); },
  async stepDay(n=1){ n=Math.max(1,n|0);
    for(let k=0;k<n;k++){ for(const sym of Object.keys(this.S.prices)){ this.S.prices[sym].push(this.nextBar(this.S.prices[sym])); this.applyEvents(sym); }
      const remain=[]; for(const o of this.S.orders){ const bar=this.S.prices[o.symbol].at(-1); const open=bar.o;
        if(o.type==='market'){ this.fill(o,open); } else { const ok=(o.side==='buy')?(open<=o.limit):(open>=o.limit); if(ok) this.fill(o,open); else remain.push(o); } }
      this.S.orders=remain; this.S.day++; this.markEquity(); }
    await this.save(); UI.render(); }
};

/* ===== 포인트(데모) ===== */
const GAME={ pointsKey:'points.wallet', wallet(){return DB.get(this.pointsKey,{balance:0,history:[]})}, saveWallet(w){DB.set(this.pointsKey,w)},
  addPoints(x,reason='achievement'){ const w=this.wallet(); w.balance+=(x|0); w.history.unshift({ts:nowTs(),delta:x,reason}); this.saveWallet(w); toast(`포인트 +${x} (${reason})`); },
  checkAchievements(){ const m=SIM.metrics(); const lastEq=SIM.S.equity.at(-1)?.v ?? SIM.S.cash; if(lastEq>1200) this.addPoints(200,'총자산 1200 초과'); if(isFinite(m.maxdd)&&m.maxdd>-0.05) this.addPoints(150,'MDD 5% 이내'); }
};

/* ===== UI ===== */
const UI={
  async renderAuth(){
    const me=await AUTH.me();
    const sess = me ? { sid:'server', user_id:me.id, accountId:me.accountId, role:me.role, expires_at:Date.now()+8*60*60*1000 } : null;
    if(me) AUTH.setSession(sess); else AUTH.clearSession();

    $('#authView').classList.toggle('hidden',!!me);
    $('#appView').classList.toggle('hidden',!me);
    if(!me){ $('#loginStatus').textContent=''; return; }

    $('#who').textContent=`로그인: ${me.accountId}`;
    $('#rolePill').textContent=`역할: ${me.role}`;
    $('#adminPanel').classList.toggle('hidden',me.role!=='PERMANENT_ADMIN');
    $('#tempPanel').classList.toggle('hidden',me.role!=='TEMP_ADMIN');

    this.renderSim(); await this.renderTickets();

    if(me.role==='PERMANENT_ADMIN'){
      try{ const r=await api('/admin-count'); $('#todayAdminCount').textContent='오늘 고유 관리자 수: '+(r.count|0); }
      catch{ $('#todayAdminCount').textContent='오늘 고유 관리자 수: —'; }
    }
  },
  renderSim(){ $('#fee').value=SIM.S.settings.feeBps; $('#slip').value=SIM.S.settings.slippageBps; $('#scenario').value=SIM.S.scenario||'training';
    $('#kpi-cash').textContent=fmt(SIM.S.cash); const lastEq=SIM.S.equity.at(-1)?.v ?? SIM.S.cash; $('#kpi-eq').textContent=fmt(lastEq);
    const m=SIM.metrics(); $('#kpi-cagr').textContent=isFinite(m.cagr)?(m.cagr*100).toFixed(2)+'%':'—'; $('#kpi-dd').textContent=isFinite(m.maxdd)?(m.maxdd*100).toFixed(2)+'%':'—';
    const pxBody=$('#px tbody'); pxBody.innerHTML=''; for(const [sym,arr] of Object.entries(SIM.S.prices)){ const b=arr.at(-1); const tr=document.createElement('tr'); tr.innerHTML=`<td>${sym}</td><td>${fnum(b.o)}</td><td>${fnum(b.h)}</td><td>${fnum(b.l)}</td><td>${fnum(b.c)}</td>`; pxBody.appendChild(tr); }
    const posBody=$('#pos tbody'); posBody.innerHTML=''; for(const [sym,p] of Object.entries(SIM.S.positions)){ const last=SIM.S.prices[sym]?.at(-1)?.c ?? 0; const u=(last-p.avg)*p.qty; const tr=document.createElement('tr');
      tr.innerHTML=`<td>${sym}</td><td>${p.qty}</td><td>${fnum(p.avg)}</td><td>${fnum(last)}</td><td style="color:${u>=0?'#2ee59d':'#ff4d61'}">${fmt(u)}</td>`; posBody.appendChild(tr); }
    const fillBody=$('#fills tbody'); fillBody.innerHTML=''; for(const f of SIM.S.fills){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${f.date}</td><td>${f.symbol}</td><td>${f.side}</td><td>${f.qty}</td><td>${fnum(f.px)}</td><td>${fnum(f.fees)}</td>`; fillBody.appendChild(tr); }
    const tags=$('#tags'); tags.innerHTML=''; tags.append(...Object.keys(SIM.S.prices).map(s=>{ const el=document.createElement('span'); el.className='badge'; el.textContent=s; return el; })); this.drawChart(); },
  drawChart(){ const c=$('#chart'),ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); const eq=SIM.S.equity.length?SIM.S.equity:[{t:SIM.startDate,v:SIM.S.cash}];
    const xs=eq.map((d,i)=>i/(eq.length-1||1)); const min=Math.min(...eq.map(d=>d.v)); const max=Math.max(...eq.map(d=>d.v));
    ctx.strokeStyle='#213050'; ctx.lineWidth=1; for(let y=0;y<4;y++){ const yy=10+(c.height-20)*y/3; ctx.beginPath(); ctx.moveTo(40,yy); ctx.lineTo(c.width-10,yy); ctx.stroke(); }
    ctx.beginPath(); ctx.strokeStyle='#6aa3ff'; ctx.lineWidth=2; eq.forEach((d,i)=>{ const x=40+(c.width-60)*xs[i]; const y=10+(c.height-20)*(1-(d.v-min)/(max-min||1)); i?ctx.lineTo(x,y):ctx.moveTo(x,y); }); ctx.stroke();
    ctx.fillStyle='#9fb3d9'; ctx.font='12px ui-sans-serif'; ctx.fillText(fnum(max),6,18); ctx.fillText(fnum(min),6,c.height-8); },
  renderTickets: async function(){ 
    const me=await AUTH.me(); 
    if(!me){ $('#ticketsBox').innerHTML='<span class="small">최근 문의 없음</span>'; return; }
    try{
      const r=await api('/tickets');
      const list=r.items||[];
      const top=list.slice(0, me.role==='PERMANENT_ADMIN'?20:5);
      $('#ticketsBox').innerHTML = top.length
        ? top.map(t=>`• [${t.status}] ${t.title} — ${new Date(t.created_at).toLocaleString()}`).join('<br>')
        : '<span class="small">문의 없음</span>';
    }catch{ $('#ticketsBox').innerHTML='<span class="small">문의 로드 실패</span>'; }
  }
};

/* ===== 로그 ===== */
function log(msg){ const t=new Date().toLocaleTimeString(); const el=$('#cmdlog'); if(!el) return console.log('[CMD]',msg); el.textContent += `[${t}] ${msg}\n`; el.scrollTop=el.scrollHeight; }
const PRESETS={B1:"buy AAPL 10 market",S1:"sell AAPL 5 market",N5:"next 5",H1:"help"};
async function runCommand(raw){
  if(!raw||!raw.trim()) return;
  const key=raw.trim().toUpperCase(); if(PRESETS[key]){ runCommand(PRESETS[key]); return; }
  const parts=raw.trim().split(/\s+/); const cmd=parts[0].toLowerCase();
  if(cmd==='help'||cmd==='h'||cmd==='?'){ log(`명령: buy/sell <SYM> <QTY|all> market|limit <PX> | next [N] | set fee|slip <bps> | positions | stats`); return; }
  if(cmd==='buy'||cmd==='sell'){
    const side=cmd, sym=(parts[1]||'').toUpperCase(); let qty;
    if((parts[2]||'').toLowerCase()==='all'){ qty=(SIM.S.positions[sym]?.qty)||0; } else { qty=Number(parts[2]); }
    if(!sym||!Number.isFinite(qty)||qty<1){ log(`사용법: ${side} <SYM> <QTY|all> market|limit <PX>`); return; }
    let type='market', limit=null; if(parts[3]){ const t=parts[3].toLowerCase(); if(t==='limit'){ type='limit'; limit=Number(parts[4]); if(!(limit>0)) { log('유효한 지정가 필요'); return; } } }
    SIM.place({symbol:sym, qty:Math.floor(qty), side, type, limit}); await SIM.save(); UI.render();
    log(`${side.toUpperCase()} ${sym} x ${Math.floor(qty)} ${type}${limit?(' @'+limit):''} 주문`);
    return;
  }
  if(cmd==='next'){ const n=parts[1]?Math.max(1,Number(parts[1])|0):1; await SIM.stepDay(n); log(`${n}일 진행`); return; }
  if(cmd==='set'){ const w=(parts[1]||'').toLowerCase(); const val=Number(parts[2]); if(!Number.isFinite(val)||val<0){ log('유효한 bps'); return; }
    if(w==='fee'){ SIM.S.settings.feeBps=val; $('#fee').value=val; await SIM.save(); log(`수수료 ${val}bps`); return; }
    if(w==='slip'){ SIM.S.settings.slippageBps=val; $('#slip').value=val; await SIM.save(); log(`슬리피지 ${val}bps`); return; }
    log('가능: fee, slip'); return; }
  if(cmd==='positions'||cmd==='pos'){ const lines=Object.entries(SIM.S.positions).map(([sym,p])=>{ const last=SIM.S.prices[sym]?.at(-1)?.c??0; const u=(last-p.avg)*p.qty; return `${sym} qty=${p.qty}, avg=${fnum(p.avg)}, last=${fnum(last)}, PnL=${fmt(u)}`; });
    log(lines.length?lines.join('\n'):'포지션 없음'); return; }
  if(cmd==='stats'){ const m=SIM.metrics(); const lastEq=SIM.S.equity.at(-1)?.v ?? SIM.S.cash; log(`현금=${fmt(SIM.S.cash)}, 총자산=${fmt(lastEq)}, CAGR=${isFinite(m.cagr)?(m.cagr*100).toFixed(2)+'%':'—'}, MDD=${isFinite(m.maxdd)?(m.maxdd*100).toFixed(2)+'%':'—'}`); return; }
  log('알 수 없는 명령. help 입력');
}

/* ===== 위험 로그 ===== */
async function logRisk(action, details={}){ try{ await api('/risk-action',{method:'POST', body:{ action, details, device:navigator.userAgent }}); }catch(e){} }

/* ===== 바인딩 ===== */
function bindAuth(){
  $('#btnRegister').onclick= async ()=>{ 
    try{
      await api('/register',{method:'POST', body:{
        accountId:$('#regId').value.trim(),
        nickname:$('#regNick').value.trim(),
        password:$('#regPw').value,
        pin:($('#regPin').value||'').trim()||undefined
      }});
      toast('가입 완료');
    }catch(e){ toast('가입 실패: '+(e?.data?.msg||e.message)); }
  };
  $('#btnLogin').onclick= async ()=>{ 
    const accountId=$('#loginId').value.trim(), password=$('#loginPw').value;
    try{
      await api('/login',{method:'POST', body:{accountId,password}});
      toast('로그인 성공'); await UI.renderAuth();
    }catch(e){
      const d=e?.data||{};
      if(d.msg==='account contains profanity; contact support'){ $('#loginStatus').innerHTML='<span class="warn">비속어 계정 제한: 지원에 문의하세요</span>'; return; }
      if(d.hard){ $('#loginStatus').innerHTML='<span class="warn">하드 락: 복구 PIN 또는 타이머 종료 후 시도</span>'; }
      else if(d.cool){ const left=Math.ceil((d.until- Date.now())/1000); $('#loginStatus').innerHTML=`<span class="warn">잠시 후 다시 시도 (${left}s)</span>`; }
      else { $('#loginStatus').innerHTML=`<span class="warn">로그인 실패${d.failCount?'('+d.failCount+'회)':''}</span>`; }
    }
  };
  $('#loginPw').addEventListener('keydown',e=>{ if(e.key==='Enter') $('#btnLogin').click(); });

  $('#btnOpenRecovery').onclick=()=>$('#recoveryModal').style.display='flex';
  $('#pinClose').onclick=()=>$('#recoveryModal').style.display='none';
  $('#pinVerify').onclick= async ()=>{ 
    const acc=$('#loginId').value.trim(); const pin=$('#pinInput').value.trim();
    try{ await api('/recovery',{method:'POST', body:{accountId:acc, pin}}); $('#pinMsg').textContent='해제됨'; toast('락 해제'); $('#recoveryModal').style.display='none'; }
    catch{ $('#pinMsg').textContent='PIN 불일치'; }
  };

  $('#btnOpenHelp').onclick=()=>$('#helpModal').style.display='flex';
  $('#btnOpenHelp2').onclick=()=>$('#helpModal').style.display='flex';
  $('#mClose').onclick=()=>$('#helpModal').style.display='none';
  $('#mSubmit').onclick= async ()=>{ 
    try{ await api('/tickets',{method:'POST', body:{category:$('#mCat').value,title:$('#mTitle').value,body:$('#mBody').value,meta:{auto:$('#mMeta').checked}}}); 
      toast('문의 접수됨'); $('#helpModal').style.display='none'; }catch(e){ toast('문의 실패: '+(e?.data?.msg||e.message)); }
  };
}
function bindApp(){
  $('#btnLogout').onclick= async ()=>{ await api('/logout',{method:'POST'}); AUTH.clearSession(); await UI.renderAuth(); };
  $('#btnHelpIn').onclick=()=>{ $('#helpModal').style.display='flex'; };

  $('#place').onclick= async ()=>{ 
    const symbol=$('#sym').value, qty=+$('#qty').value, side=$('#side').value, type=$('#otype').value, limit=$('#lpx').value?+$('#lpx').value:null; 
    SIM.place({symbol,qty,side,type,limit}); await SIM.save(); UI.render();
    log(`${side.toUpperCase()} ${symbol.toUpperCase()} x ${qty} ${type}${limit?(' @'+limit):''} 주문`);
  };
  $('#next').onclick= async ()=>{ SIM.S.scenario=$('#scenario').value; await SIM.stepDay(1); log('1일 진행'); };
  $('#reset').onclick=()=>{ openRisk('전체 초기화 — 계정ID 일치 입력 + 10초 유예 후 실행', async ()=>{ await logRisk('reset',{reason:'user_request'}); SIM.S=SIM.initState(); await SIM.save(); await SIM.load(); UI.renderSim(); toast('초기화 완료'); }); };
  $('#fee').addEventListener('change',async e=>{ SIM.S.settings.feeBps=+e.target.value||0; await SIM.save(); });
  $('#slip').addEventListener('change',async e=>{ SIM.S.settings.slippageBps=+e.target.value||0; await SIM.save(); });
  $('#run').onclick=()=>{ runCommand($('#cmd').value); $('#cmd').value=''; };
  $('#cmd').addEventListener('keydown',e=>{ if(e.key==='Enter') $('#run').click(); });

  // 관리자 힌트 버튼
  $('#btnAdminTrigger').onclick=()=>{ toast('역할 배지를 3초 내 3번 탭하면 관리자 인증창이 열립니다'); };

  // 역할 배지 3초 내 3연타 → 비번 모달
  const rolePillEl = $('#rolePill');
  if (rolePillEl) {
    rolePillEl.addEventListener('click', () => {
      AUTH.me().then(me => {
        if (!me) return;
        roleClickCount++;
        clearTimeout(roleClickTimer);
        roleClickTimer = setTimeout(()=>{ roleClickCount = 0; }, 3000); // 3초
        if (roleClickCount >= 3) {
          roleClickCount = 0;
          openAdminPwModal();
        }
      });
    });
  }
  $('#adminPwClose').onclick = () => closeAdminPwModal();
  $('#adminPwSubmit').onclick = async () => {
    const pw = $('#adminPwInput').value;
    $('#adminPwMsg').textContent = '';
    try {
      await api('/admin-login', { method:'POST', body:{ password: pw } });
      toast('관리자 권한 활성화');
      closeAdminPwModal();
      await UI.renderAuth();
    } catch(e) {
      $('#adminPwMsg').textContent = '인증 실패: ' + (e?.data?.msg || e.message);
    }
  };

  // 임시 관리자 OTK
  $('#btnOTK').onclick= async ()=>{ 
    try{ const v=$('#otk').value.trim(); const r=await api('/otk/verify',{method:'POST', body:{input:v}}); await api('/admin-use',{method:'POST'}); toast('임시 관리자 전환(20분)');
      await UI.renderAuth(); }catch(e){ toast('OTK 실패: '+(e?.data?.msg||e.message)); }
  };

  // 위험 명령(계정 삭제/가격 강제)
  $('#btnRiskDeleteAccount').onclick=()=>{ openRisk('계정 삭제(복구 불가) — 계정ID 일치 + 10초 유예', async ()=>{ await logRisk('delete_account'); toast('서버 정책에 맞춰 계정 삭제 API 구현 필요'); }); };

  // 가격 강제: 퍼센트(예: 10 = +10%, -7 = -7%) 또는 절대가 입력 허용
  $('#btnRiskForcePrice').onclick=()=>{ 
    openRisk('주가 강제 변경 — 계정ID 일치 + 10초 유예', async ()=>{
      let v = prompt('변경값을 입력하세요. 예: 10(%) 또는 =150(절대가, "=" 접두)');
      if(v==null) return;
      v = v.trim();
      await logRisk('force_price',{input:v});
      const isAbs = v.startsWith('=');
      let amt = Number(isAbs ? v.slice(1) : v);
      for(const [sym,arr] of Object.entries(SIM.S.prices)){
        const b=arr.at(-1);
        if(isAbs && amt>0){
          const ratio = amt / b.c;
          b.c = Math.max(1, amt);
          b.o = b.c/ratio; // 대략 보정
        }else{
          if(!Number.isFinite(amt)) continue;
          const dv = amt/100;
          b.c = Math.max(1, b.c*(1+dv));
        }
        b.h=Math.max(b.h,b.c); b.l=Math.min(b.l,b.c);
      }
      await SIM.save(); UI.renderSim(); toast('강제 변경 적용');
    });
  };

  $('#btnSubmitTicket').onclick= async ()=>{ 
    const me=await AUTH.me(); if(!me){ toast('로그인 필요'); return; }
    try{ await api('/tickets',{method:'POST', body:{category:$('#helpCat').value,title:$('#helpTitle').value,body:$('#helpBody').value,meta:{auto:$('#helpMeta').checked}}}); await UI.renderTickets(); toast('문의 접수됨'); }catch(e){ toast('문의 실패: '+(e?.data?.msg||e.message)); }
  };
}

/* ===== 위험 게이트 호출 ===== */
async function openRisk(title, taskFn){
  const me=await AUTH.me(); if(!me){ toast('로그인 필요'); return; }
  $('#riskModal').style.display='flex';
  $('#riskSummary').textContent=title;
  $('#riskAccount').value='';
  $('#riskCountdown').textContent='';
  let resolved=false;
  const ok=await new Promise(res=>{ RISK.resolve=res; });
  if(!ok){ toast('작업이 취소되었습니다'); return; }
  await taskFn();
}

/* ===== 모달 버튼 ===== */
function bindModals(){
  $('#riskCancel').onclick=()=>{ RISK.close(); };
  $('#riskConfirm').onclick= async ()=>{
    const me=await AUTH.me(); if(!me){ toast('세션 없음'); return; }
    const acc=$('#riskAccount').value.trim();
    if(acc!==me.accountId){ toast('계정ID 불일치'); return; }
    RISK.startCountdown(); toast('10초 유예 시작 — 취소하려면 닫기');
  };
}

/* ===== 부트스트랩 ===== */
async function bootstrap(){
  await SIM.load();
  await UI.renderAuth();
  bindAuth(); bindApp(); bindModals();
}
bootstrap();
</script>
</body>
</html>
